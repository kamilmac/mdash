<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mdash</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#111113;--bg2:#1a1a1e;--bg3:#252529;
  --fg:#d4d4d8;--fg2:#a1a1aa;--fg3:#52525b;
  --accent:#7aa2f7;--accent2:#bb9af7;
  --border:#2a2a30;
  --code-bg:#161618;
  --warn-bg:#3d2e00;--warn-fg:#e0af68;
  --sidebar-w:min(480px,85vw);
  --radius:6px;
}
[data-theme="light"]{
  --bg:#f5f5f5;--bg2:#ffffff;--bg3:#e8e8e8;
  --fg:#1a1b26;--fg2:#343b58;--fg3:#9499b7;
  --accent:#2e59a8;--accent2:#7847bd;
  --border:#d0d0d0;
  --code-bg:#eaeaf2;
  --warn-bg:#fff3cd;--warn-fg:#856404;
}
html{font-size:16px}
body{
  background:var(--bg);color:var(--fg);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  line-height:1.7;min-height:100vh;
  transition:background .2s,color .2s;
}

/* Floating icon buttons */
.icon-left{position:fixed;top:12px;left:12px;z-index:100}
.icon-right{position:fixed;top:12px;right:12px;z-index:100;display:flex;gap:4px}

button{
  background:none;border:none;color:var(--fg3);cursor:pointer;
  padding:6px;border-radius:var(--radius);font-size:.875rem;
  display:flex;align-items:center;gap:4px;
  transition:background .15s,color .15s;
}
button:hover{background:var(--bg3);color:var(--fg)}
button svg{width:18px;height:18px}

/* Truncation banner */
.truncation-banner{
  display:none;
  position:fixed;top:0;left:0;right:0;z-index:90;
  padding:8px 16px;
  background:var(--warn-bg);color:var(--warn-fg);
  font-size:.875rem;text-align:center;
  border-bottom:1px solid var(--warn-fg);
}
.truncation-banner.visible{display:block}

/* Main content */
.content{
  max-width:780px;margin:0 auto;
  padding:48px 24px 48px;
}

/* Page-load reveal */
@keyframes revealUp{
  from{opacity:0;transform:translateY(16px)}
  to{opacity:1;transform:translateY(0)}
}
.rendered.reveal{animation:revealUp .6s cubic-bezier(.16,1,.3,1) both}

/* Rendered markdown */
.rendered h1,.rendered h2,.rendered h3,.rendered h4,.rendered h5,.rendered h6{
  color:var(--fg);margin:1.5em 0 .5em;font-weight:600;line-height:1.3;
}
.rendered h1{font-size:2em;border-bottom:1px solid var(--border);padding-bottom:.3em}
.rendered h2{font-size:1.5em;border-bottom:1px solid var(--border);padding-bottom:.25em}
.rendered h3{font-size:1.25em}
.rendered p{margin:.8em 0}
.rendered a{color:var(--accent);text-decoration:none}
.rendered a:hover{text-decoration:underline}
.rendered strong{color:var(--fg);font-weight:600}
.rendered blockquote{
  border-left:3px solid var(--accent2);padding:.5em 1em;margin:1em 0;
  color:var(--fg2);background:var(--bg2);border-radius:0 var(--radius) var(--radius) 0;
}
.rendered ul,.rendered ol{padding-left:1.5em;margin:.5em 0}
.rendered li{margin:.25em 0}
.rendered code{
  background:var(--code-bg);padding:.15em .4em;border-radius:3px;
  font-size:.9em;font-family:'SF Mono',Consolas,'Liberation Mono',Menlo,monospace;
}
.rendered pre{
  background:var(--code-bg);padding:1em;border-radius:var(--radius);
  overflow-x:auto;margin:1em 0;border:1px solid var(--border);
}
.rendered pre code{background:none;padding:0;font-size:.875em}
.rendered table{
  border-collapse:collapse;width:100%;margin:1em 0;
}
.rendered th,.rendered td{
  border:1px solid var(--border);padding:.5em .75em;text-align:left;
}
.rendered th{background:var(--bg2);font-weight:600}
.rendered img{max-width:100%;border-radius:var(--radius)}
.rendered hr{border:none;border-top:1px solid var(--border);margin:2em 0}

/* Empty state */
.empty-state{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:60vh;color:var(--fg3);text-align:center;
}
.empty-state h2{font-size:1.5rem;margin-bottom:.5rem;color:var(--fg2)}
.empty-state p{font-size:.95rem;max-width:400px}
.empty-state kbd{
  background:var(--bg3);padding:2px 6px;border-radius:3px;
  font-size:.85em;border:1px solid var(--border);
}

/* Sidebar overlay */
.overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:200;
  background:rgba(0,0,0,.5);opacity:0;pointer-events:none;
  transition:opacity .2s;
}
.overlay.open{opacity:1;pointer-events:all}

/* Sidebar / Editor */
.sidebar{
  position:fixed;top:0;left:0;bottom:0;z-index:300;
  width:var(--sidebar-w);
  background:var(--bg);border-right:1px solid var(--border);
  transform:translateX(-100%);transition:transform .25s ease;
  display:flex;flex-direction:column;
}
.sidebar.open{transform:translateX(0)}
.sidebar-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 12px;
  min-height:48px;
}
.sidebar-header span{font-weight:600;font-size:.95rem}
.editor-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden}
.editor{
  flex:1;width:100%;resize:none;border:none;outline:none;
  background:var(--bg);color:var(--fg);
  font-family:'SF Mono',Consolas,'Liberation Mono',Menlo,monospace;
  font-size:.875rem;line-height:1.6;padding:16px;
  tab-size:2;
}
.editor::placeholder{color:var(--fg3)}
.editor-footer{
  padding:8px 12px;
  display:flex;align-items:center;justify-content:space-between;
  font-size:.8rem;color:var(--fg3);
}

/* Toast */
.toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--bg2);color:var(--fg);border:1px solid var(--border);
  padding:8px 16px;border-radius:var(--radius);font-size:.875rem;
  opacity:0;transition:transform .3s,opacity .3s;z-index:999;
  pointer-events:none;
}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}

/* Encrypted landing screen */
.encrypted-screen{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:500;
  background:var(--bg);display:flex;align-items:center;justify-content:center;
  flex-direction:column;gap:8px;
}
.encrypted-screen input{
  padding:8px 12px;border-radius:var(--radius);
  border:1px solid var(--border);background:transparent;color:var(--fg);
  font-size:.9rem;outline:none;text-align:center;width:200px;
}
.encrypted-screen input:focus{border-color:var(--fg3)}
.encrypted-screen .error-msg{
  color:#f87171;font-size:.8rem;height:1.2em;
}
@keyframes shake{
  0%,100%{transform:translateX(0)}
  15%,45%,75%{transform:translateX(-6px)}
  30%,60%,90%{transform:translateX(6px)}
}
.shake{animation:shake .4s ease-in-out}

/* Lock toggle in editor footer */
.lock-btn{
  display:flex;align-items:center;gap:2px;
  padding:2px 6px;border-radius:3px;
  font-size:.8rem;cursor:pointer;
  background:none;border:none;color:var(--fg3);
  transition:color .15s,background .15s;
}
.lock-btn:hover{color:var(--fg);background:var(--bg3)}
.lock-btn.active{color:var(--accent)}
.lock-btn svg{width:14px;height:14px}
.footer-left{display:flex;align-items:center;gap:8px}
.password-inline{
  display:none;align-items:center;gap:4px;
}
.password-inline.visible{display:flex}
.password-inline input{
  width:100px;padding:2px 6px;border-radius:3px;
  border:1px solid var(--border);background:var(--bg);color:var(--fg);
  font-size:.75rem;outline:none;
  font-family:inherit;
}
.password-inline input:focus{border-color:var(--accent)}

/* Desktop: sidebar pushes content */
@media(min-width:641px){
  :root{--sidebar-w:clamp(400px,42vw,640px)}
  .content{transition:margin-left .25s ease}
  body.sidebar-open .content{margin-left:var(--sidebar-w)}
  .overlay.open{opacity:0;pointer-events:none}
}

/* Mobile */
@media(max-width:640px){
  .sidebar{width:100vw}
  .content{padding:48px 16px 32px}
}
</style>
</head>
<body>

<!-- Floating icons -->
<div class="icon-left">
  <button id="menuBtn" aria-label="Open editor">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
  </button>
</div>
<div class="icon-right">
  <button id="copyBtn" aria-label="Copy link">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
  </button>
  <button id="themeBtn" aria-label="Toggle theme">
    <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
  </button>
</div>

<!-- Truncation banner -->
<div class="truncation-banner" id="truncBanner">
  Content was truncated to fit the URL character limit.
</div>

<!-- Main content area -->
<div class="content">
  <div class="rendered" id="rendered"></div>
  <div class="empty-state" id="emptyState">
    <h2>mdash</h2>
    <p>Markdown in a URL. Click the <kbd>&#9998;</kbd> pencil to start writing, or open a shared link.</p>
  </div>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>

<!-- Sidebar editor -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <span>Editor</span>
    <button id="closeBtn" aria-label="Close editor">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="editor-wrap">
    <textarea class="editor" id="editor" placeholder="Write markdown here..." spellcheck="false"></textarea>
    <div class="editor-footer">
      <div class="footer-left">
        <span id="charCount">0 chars</span>
        <button class="lock-btn" id="lockBtn" aria-label="Toggle encryption" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        </button>
        <div class="password-inline" id="passwordInline">
          <input type="password" id="encPasswordInput" placeholder="password" autocomplete="off">
        </div>
      </div>
      <span id="encStatus"></span>
    </div>
  </div>
</div>

<!-- Encrypted landing screen -->
<div class="encrypted-screen" id="encryptedScreen" style="display:none">
  <input type="password" id="decryptInput" placeholder="password" autocomplete="off">
  <div class="error-msg" id="decryptError"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- lz-string (v1.5.0, MIT, inlined for zero dependencies) -->
<script>
var LZString=function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={},e={compressToEncodedURIComponent:function(o){return null==o?"":""==o?"":e._compress(o,6,function(o){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$".charAt(o)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:(r=r.replace(/ /g,"+"),e._decompress(r.length,32,function(n){return o("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",r.charAt(n))}))},_compress:function(o,n,t){if(null==o)return"";var e,i,s,p={},u={},a="",c="",l="",f=2,d=3,h=2,g=[],v=0,m=0;for(s=0;s<o.length;s+=1)if(a=o.charAt(s),Object.prototype.hasOwnProperty.call(p,a)||(p[a]=d++,u[a]=!0),c=l+a,Object.prototype.hasOwnProperty.call(p,c))l=c;else{if(Object.prototype.hasOwnProperty.call(u,l)){if(l.charCodeAt(0)<256){for(e=0;e<h;e++)v<<=1,m==n-1?(m=0,g.push(t(v)),v=0):m++;for(i=l.charCodeAt(0),e=0;e<8;e++)v=v<<1|1&i,m==n-1?(m=0,g.push(t(v)),v=0):m++,i>>=1}else{for(i=1,e=0;e<h;e++)v=v<<1|i,m==n-1?(m=0,g.push(t(v)),v=0):m++,i=0;for(i=l.charCodeAt(0),e=0;e<16;e++)v=v<<1|1&i,m==n-1?(m=0,g.push(t(v)),v=0):m++,i>>=1}0==--f&&(f=Math.pow(2,h),h++),delete u[l]}else for(i=p[l],e=0;e<h;e++)v=v<<1|1&i,m==n-1?(m=0,g.push(t(v)),v=0):m++,i>>=1;0==--f&&(f=Math.pow(2,h),h++),p[c]=d++,l=a}if(""!==l){if(Object.prototype.hasOwnProperty.call(u,l)){if(l.charCodeAt(0)<256){for(e=0;e<h;e++)v<<=1,m==n-1?(m=0,g.push(t(v)),v=0):m++;for(i=l.charCodeAt(0),e=0;e<8;e++)v=v<<1|1&i,m==n-1?(m=0,g.push(t(v)),v=0):m++,i>>=1}else{for(i=1,e=0;e<h;e++)v=v<<1|1&i,m==n-1?(m=0,g.push(t(v)),v=0):m++,i=0;for(i=l.charCodeAt(0),e=0;e<16;e++)v=v<<1|1&i,m==n-1?(m=0,g.push(t(v)),v=0):m++,i>>=1}0==--f&&(f=Math.pow(2,h),h++),delete u[l]}else for(i=p[l],e=0;e<h;e++)v=v<<1|1&i,m==n-1?(m=0,g.push(t(v)),v=0):m++,i>>=1}for(i=2,e=0;e<h;e++)v=v<<1|1&i,m==n-1?(m=0,g.push(t(v)),v=0):m++,i>>=1;for(;;){if(v<<=1,m==n-1){g.push(t(v));break}m++}return g.join("")},_decompress:function(o,n,t){var e,i,s,p,u,a,c,l=[],f=4,d=4,h=3,g="",v=[],m={val:t(0),position:n,index:1};for(e=0;e<3;e+=1)l[e]=e;for(s=0,u=Math.pow(2,2),a=1;a!=u;)p=m.val&m.position,m.position>>=1,0==m.position&&(m.position=n,m.val=t(m.index++)),s|=(p>0?1:0)*a,a<<=1;switch(s){case 0:for(s=0,u=Math.pow(2,8),a=1;a!=u;)p=m.val&m.position,m.position>>=1,0==m.position&&(m.position=n,m.val=t(m.index++)),s|=(p>0?1:0)*a,a<<=1;c=r(s);break;case 1:for(s=0,u=Math.pow(2,16),a=1;a!=u;)p=m.val&m.position,m.position>>=1,0==m.position&&(m.position=n,m.val=t(m.index++)),s|=(p>0?1:0)*a,a<<=1;c=r(s);break;case 2:return""}for(l[3]=c,i=c,v.push(c);;){if(m.index>o)return"";for(s=0,u=Math.pow(2,h),a=1;a!=u;)p=m.val&m.position,m.position>>=1,0==m.position&&(m.position=n,m.val=t(m.index++)),s|=(p>0?1:0)*a,a<<=1;switch(c=s){case 0:for(s=0,u=Math.pow(2,8),a=1;a!=u;)p=m.val&m.position,m.position>>=1,0==m.position&&(m.position=n,m.val=t(m.index++)),s|=(p>0?1:0)*a,a<<=1;l[d++]=r(s),c=d-1,f--;break;case 1:for(s=0,u=Math.pow(2,16),a=1;a!=u;)p=m.val&m.position,m.position>>=1,0==m.position&&(m.position=n,m.val=t(m.index++)),s|=(p>0?1:0)*a,a<<=1;l[d++]=r(s),c=d-1,f--;break;case 2:return v.join("")}if(0==f&&(f=Math.pow(2,h),h++),l[c])g=l[c];else{if(c!==d)return null;g=i+i.charAt(0)}v.push(g),l[d++]=i+g.charAt(0),i=g,0==--f&&(f=Math.pow(2,h),h++)}}};return e}();
</script>

<!-- marked.js (v15, MIT, from CDN) -->
<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>

<!-- highlight.js (v11, BSD-3, subset from CDN) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github-dark.min.css" id="hlStyle">
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/highlight.min.js"></script>

<script>
(function(){
  const URL_LIMIT = 32000;
  const DEBOUNCE_MS = 2000;

  const $ = (s) => document.getElementById(s);
  const rendered = $('rendered');
  const emptyState = $('emptyState');
  const editor = $('editor');
  const sidebar = $('sidebar');
  const overlay = $('overlay');
  const truncBanner = $('truncBanner');
  const charCount = $('charCount');
  const encStatus = $('encStatus');
  const toast = $('toast');

  // --- Crypto ---
  async function deriveKey(password, salt) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
      'raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']
    );
    return crypto.subtle.deriveKey(
      { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
      keyMaterial,
      { name: 'AES-GCM', length: 256 },
      false,
      ['encrypt', 'decrypt']
    );
  }

  async function encryptContent(content, password) {
    const enc = new TextEncoder();
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await deriveKey(password, salt);
    const ciphertext = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv },
      key,
      enc.encode(content)
    );
    // Pack: salt(16) + iv(12) + ciphertext
    const packed = new Uint8Array(salt.length + iv.length + ciphertext.byteLength);
    packed.set(salt, 0);
    packed.set(iv, salt.length);
    packed.set(new Uint8Array(ciphertext), salt.length + iv.length);
    // base64url encode (chunked to avoid stack overflow on large payloads)
    let binary = '';
    for (let i = 0; i < packed.length; i++) binary += String.fromCharCode(packed[i]);
    let b64 = btoa(binary);
    b64 = b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    return b64;
  }

  async function decryptContent(data, password) {
    // base64url decode
    let b64 = data.replace(/-/g, '+').replace(/_/g, '/');
    while (b64.length % 4) b64 += '=';
    const raw = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    const salt = raw.slice(0, 16);
    const iv = raw.slice(16, 28);
    const ciphertext = raw.slice(28);
    const key = await deriveKey(password, salt);
    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv },
      key,
      ciphertext
    );
    return new TextDecoder().decode(decrypted);
  }

  // --- Theme ---
  const themeBtn = $('themeBtn');
  const hlStyle = document.getElementById('hlStyle');

  function getTheme() {
    return localStorage.getItem('mdash-theme') || 'dark';
  }
  function setTheme(t) {
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('mdash-theme', t);
    hlStyle.href = t === 'dark'
      ? 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github-dark.min.css'
      : 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github.min.css';
    $('themeIcon').innerHTML = t === 'dark'
      ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>'
      : '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
  }
  setTheme(getTheme());
  themeBtn.addEventListener('click', () => setTheme(getTheme() === 'dark' ? 'light' : 'dark'));

  // --- Sidebar ---
  function openSidebar() {
    sidebar.classList.add('open');
    overlay.classList.add('open');
    document.body.classList.add('sidebar-open');
    editor.focus();
  }
  function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('open');
    document.body.classList.remove('sidebar-open');
  }
  $('menuBtn').addEventListener('click', openSidebar);
  $('closeBtn').addEventListener('click', closeSidebar);
  overlay.addEventListener('click', closeSidebar);

  // --- Markdown rendering ---
  marked.setOptions({
    breaks: true,
    gfm: true,
    highlight: function(code, lang) {
      if (lang && hljs.getLanguage(lang)) {
        return hljs.highlight(code, { language: lang }).value;
      }
      return hljs.highlightAuto(code).value;
    }
  });

  function renderMarkdown(md) {
    if (!md || !md.trim()) {
      rendered.innerHTML = '';
      rendered.style.display = 'none';
      emptyState.style.display = 'flex';
      return;
    }
    emptyState.style.display = 'none';
    rendered.style.display = 'block';
    rendered.innerHTML = marked.parse(md);
    rendered.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightElement(block);
    });
  }

  // --- Encoding / Decoding ---
  function encode(content) {
    return LZString.compressToEncodedURIComponent(content);
  }

  function decode(encoded) {
    return LZString.decompressFromEncodedURIComponent(encoded);
  }

  function encodeWithTruncation(content, limit) {
    let encoded = encode(content);
    if (encoded.length <= limit) {
      return { encoded, truncated: false, originalSize: content.length, keptSize: content.length };
    }
    const ratio = encoded.length / content.length;
    let targetLen = Math.floor(limit / ratio * 0.9);
    let truncated = content.substring(0, targetLen);
    const lastNewline = truncated.lastIndexOf('\n');
    if (lastNewline > targetLen * 0.5) {
      truncated = truncated.substring(0, lastNewline);
    }
    encoded = encode(truncated);
    if (encoded.length > limit) {
      targetLen = Math.floor(targetLen * (limit / encoded.length) * 0.95);
      truncated = content.substring(0, targetLen);
      const ln = truncated.lastIndexOf('\n');
      if (ln > targetLen * 0.5) truncated = truncated.substring(0, ln);
      encoded = encode(truncated);
    }
    return { encoded, truncated: true, originalSize: content.length, keptSize: truncated.length };
  }

  // --- Lock toggle + encryption password ---
  const lockBtn = $('lockBtn');
  const passwordInline = $('passwordInline');
  const encPasswordInput = $('encPasswordInput');
  let encryptionActive = false;

  lockBtn.addEventListener('click', () => {
    encryptionActive = !encryptionActive;
    lockBtn.classList.toggle('active', encryptionActive);
    passwordInline.classList.toggle('visible', encryptionActive);
    if (encryptionActive) {
      encPasswordInput.focus();
    } else {
      encPasswordInput.value = '';
      // Revert to plain URL
      const content = editor.value;
      updateURL(content);
    }
  });

  encPasswordInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => updateURL(editor.value), DEBOUNCE_MS);
  });

  function getEncryptionPassword() {
    if (!encryptionActive) return null;
    const pw = encPasswordInput.value;
    return pw ? pw : null;
  }

  // --- URL management ---
  async function updateURL(content) {
    if (!content || !content.trim()) {
      history.replaceState(null, '', window.location.pathname);
      truncBanner.classList.remove('visible');
      return;
    }

    const password = getEncryptionPassword();
    if (password) {
      truncBanner.classList.remove('visible');
      const params = new URLSearchParams(window.location.search);
      params.delete('t');
      try {
        const encrypted = await encryptContent(content, password);
        const hash = 'e:' + encrypted;
        if (hash.length > URL_LIMIT) {
          encStatus.textContent = 'too large';
          return;
        }
        const search = params.toString() ? '?' + params.toString() : '';
        history.replaceState(null, '', search + '#' + hash);
      } catch (e) {
        encStatus.textContent = 'error';
      }
      return;
    }

    const result = encodeWithTruncation(content, URL_LIMIT);
    const params = new URLSearchParams(window.location.search);
    if (result.truncated) {
      params.set('t', '1');
      truncBanner.classList.add('visible');
    } else {
      params.delete('t');
      truncBanner.classList.remove('visible');
    }
    const search = params.toString() ? '?' + params.toString() : '';
    history.replaceState(null, '', search + '#' + result.encoded);
  }

  function loadFromURL() {
    const hash = window.location.hash.substring(1);
    if (!hash) return { encrypted: false, content: null };
    if (hash.startsWith('e:')) {
      return { encrypted: true, data: hash.substring(2) };
    }
    const content = decode(hash);
    if (new URLSearchParams(window.location.search).has('t')) {
      truncBanner.classList.add('visible');
    }
    return { encrypted: false, content };
  }

  // --- Encrypted landing screen ---
  function showEncryptedScreen(encData) {
    const screen = $('encryptedScreen');
    const input = $('decryptInput');
    const errorMsg = $('decryptError');

    screen.style.display = 'flex';
    document.querySelector('.content').style.display = 'none';
    document.querySelector('.icon-left').style.display = 'none';
    document.querySelector('.icon-right').style.display = 'none';

    input.addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter' || !input.value) return;
      errorMsg.textContent = '';
      try {
        const password = input.value;
        const plaintext = await decryptContent(encData, password);
        screen.style.display = 'none';
        document.querySelector('.content').style.display = '';
        document.querySelector('.icon-left').style.display = '';
        document.querySelector('.icon-right').style.display = '';
        // Keep encryption active with the same password
        encryptionActive = true;
        lockBtn.classList.add('active');
        passwordInline.classList.add('visible');
        encPasswordInput.value = password;
        editor.value = plaintext;
        charCount.textContent = plaintext.length.toLocaleString() + ' chars';
        renderMarkdown(plaintext);
        rendered.classList.add('reveal');
      } catch {
        input.classList.remove('shake');
        void input.offsetWidth;
        input.classList.add('shake');
        errorMsg.textContent = 'Wrong password';
        input.value = '';
      }
    });
    setTimeout(() => input.focus(), 100);
  }

  // --- Debounce ---
  let debounceTimer = null;
  let savedTimer = null;
  editor.addEventListener('input', () => {
    const content = editor.value;
    charCount.textContent = content.length.toLocaleString() + ' chars';
    encStatus.textContent = '···';
    clearTimeout(savedTimer);
    renderMarkdown(content);
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      await updateURL(content);
      encStatus.textContent = '✓';
      savedTimer = setTimeout(() => { encStatus.textContent = ''; }, 1500);
    }, DEBOUNCE_MS);
  });

  // --- Copy link ---
  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
  }

  $('copyBtn').addEventListener('click', () => {
    const url = window.location.href;
    if (!window.location.hash) {
      showToast('Nothing to copy — start writing first');
      return;
    }
    navigator.clipboard.writeText(url).then(() => {
      showToast('Link copied!');
    }).catch(() => {
      showToast('Failed to copy');
    });
  });

  // --- Keyboard shortcuts ---
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && sidebar.classList.contains('open')) {
      closeSidebar();
    }
  });

  // --- Init ---
  const result = loadFromURL();
  if (result.encrypted) {
    showEncryptedScreen(result.data);
  } else if (result.content) {
    editor.value = result.content;
    charCount.textContent = result.content.length.toLocaleString() + ' chars';
    renderMarkdown(result.content);
    rendered.classList.add('reveal');
  }
})();
</script>
</body>
</html>
